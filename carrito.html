<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carrito - GameVibe</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="navbar-placeholder"></div>
  <script>
    fetch('components/navbar.html').then(r=>r.text()).then(html=>document.getElementById('navbar-placeholder').innerHTML = html).catch(()=>{});
  </script>

  <main class="container my-5">
    <h1 class="h4 mb-4">Tu carrito</h1>

    <div id="cart-container">
      <!-- renderizado por JS -->
      <div class="text-muted">Cargando carrito...</div>
    </div>

    <div class="mt-4 d-flex justify-content-between align-items-center">
      <div>
        <button id="clear-cart" class="btn btn-outline-danger">Vaciar carrito</button>
      </div>
      <div class="text-end">
        <div class="small text-muted">Total:</div>
        <div id="cart-total" class="fs-4 fw-bold">$0.00</div>
        <button id="checkout" class="btn btn-primary mt-2">Pagar</button>
      </div>
    </div>
  </main>

  <div id="footer-placeholder"></div>
  <script>
    fetch('components/footer.html').then(r=>r.text()).then(html=>document.getElementById('footer-placeholder').innerHTML = html).catch(()=>{});
  </script>

  <script src="assets/js/cart.js"></script>
  <script>
    function formatCurrency(n){
      // muestra entero si n es entero; ajusta formato según tu moneda
      return new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 }).format(n);
    }

    function renderCart(){
      const cart = Cart.getCart();
      const container = document.getElementById('cart-container');
      if (!cart || cart.length === 0) {
        container.innerHTML = '<div class="alert alert-secondary">Tu carrito está vacío.</div>';
        document.getElementById('cart-total').textContent = formatCurrency(0);
        return;
      }

      const rows = cart.map(it => {
        const subtotal = (it.priceNum || Cart.parsePrice(it.price)) * (it.qty || 0);
        return `
          <div class="card mb-3">
            <div class="row g-0 align-items-center">
              <div class="col-auto p-3">
                <img src="${it.img || 'img/placeholder.png'}" alt="${it.title}" style="width:100px; height:75px; object-fit:cover; border-radius:6px;">
              </div>
              <div class="col">
                <div class="card-body py-2">
                  <h6 class="card-title mb-1">${it.title}</h6>
                  <div class="text-muted small mb-2">SKU: ${it.sku || ''}</div>
                  <div class="d-flex align-items-center gap-3">
                    <div>
                      <div class="small text-muted">Precio</div>
                      <div class="fw-bold">${it.price}</div>
                    </div>
                    <div>
                      <label class="small mb-1">Cantidad</label>
                      <input data-id="${it.id}" type="number" min="1" max="999" value="${it.qty}" class="form-control form-control-sm cart-qty" style="width:80px;">
                    </div>
                    <div>
                      <div class="small text-muted">Subtotal</div>
                      <div class="fw-bold">${formatCurrency(subtotal)}</div>
                    </div>
                    <div class="ms-auto">
                      <button data-id="${it.id}" class="btn btn-sm btn-outline-danger remove-item">Eliminar</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      container.innerHTML = rows;

      // actualizar total
      const total = Cart.getTotal();
      document.getElementById('cart-total').textContent = formatCurrency(total);

      // listeners para qty y remove
      document.querySelectorAll('.cart-qty').forEach(input => {
        input.addEventListener('change', function(){
          const id = this.dataset.id;
          const qty = Math.max(1, parseInt(this.value || '1', 10));
          Cart.updateQty(id, qty);
          renderCart();
        });
      });
      document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', function(){
          Cart.removeItem(this.dataset.id);
          renderCart();
        });
      });
    }

    document.getElementById('clear-cart').addEventListener('click', function(){
      Cart.clear();
      renderCart();
    });

    document.getElementById('checkout').addEventListener('click', function(){
      const total = Cart.getTotal();
      if (total <= 0) return alert('El carrito está vacío.');
      // aquí iría la integración de pago; por ahora demo:
      alert('Total a pagar: ' + formatCurrency(total) + '\n\n(acción de pago demo)');
      // tras "pago" limpiar carrito:
      Cart.clear();
      renderCart();
    });

    // inicializa.
    renderCart();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>